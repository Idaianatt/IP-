<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>IP GeoMap</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Fonts and Leaflet CSS -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" crossorigin />
  <style>
    html, body {
      height: 100%;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: geometricPrecision;
    }
    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      height: 100vh;
      box-sizing: border-box;
      overflow: hidden;
      font-family: 'Roboto', Arial, sans-serif;
      background: #f8f9fa;
      color: #202124;
      font-weight: 400;
    }
    .main-layout {
      display: flex;
      flex-direction: row;
      height: 100vh;
      width: 100vw;
      background: #f8f9fa;
    }
    .sidebar {
      width: 340px;
      min-width: 260px;
      max-width: 400px;
      height: 100vh;
      background: #fff;
      box-shadow: 0 2px 12px 0 rgba(60,64,67,0.08);
      border-radius: 0 16px 16px 0;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      z-index: 10;
      position: relative;
    }
    .sidebar-content {
      padding: 36px 28px 28px 28px;
      display: flex;
      flex-direction: column;
      height: 100%;
      box-sizing: border-box;
    }
    .sidebar-title {
      font-size: 1.8rem;
      font-weight: 700;
      color: #4285f4;
      margin-bottom: 24px;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: 'Roboto', Arial, sans-serif;
    }
    .geo-list {
      list-style: none;
      padding: 0;
      margin: 0;
      width: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: geometricPrecision;
    }
    .geo-list-group-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: #5f6368;
      margin-bottom: 6px;
      margin-top: 14px;
      letter-spacing: 0.5px;
      padding-left: 2px;
      font-family: 'Roboto', Arial, sans-serif;
    }
    .geo-list-group:first-child .geo-list-group-title {
      margin-top: 0;
    }
    .geo-list-group {
      margin-bottom: 0;
      padding-bottom: 0;
    }
    .geo-list-divider {
      height: 1px;
      background: #e0e0e0;
      margin: 18px 0 10px 0;
      border: none;
    }
    .geo-list li {
      font-size: 1.08rem;
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: flex-start;
      margin-bottom: 3px;
      padding-left: 2px;
      font-family: 'Roboto', Arial, sans-serif;
    }
    .geo-list-group:not(:last-child) {
      margin-bottom: 10px;
    }
    .geo-list li strong {
      color: #5f6368;
      min-width: 0;
      font-weight: 500;
      font-size: 1.08rem;
      margin-right: 8px;
      text-align: left;
      font-family: 'Roboto', Arial, sans-serif;
    }
    .geo-list li span {
      color: #1a73e8;
      font-weight: 500;
      font-size: 1.12rem;
      word-break: break-all;
      text-align: left;
      transition: color 0.2s, text-decoration 0.2s;
      font-family: 'Roboto', Arial, sans-serif;
    }
    .geo-list li span.link {
      color: #1a73e8;
    }
    .geo-list li span.link:hover {
      color: #b5bac1;
      text-decoration: underline;
      cursor: pointer;
    }
    .geo-list li span.mono {
      font-family: 'Roboto', Arial, sans-serif;
      font-size: 1.12rem;
      color: #1a73e8;
      font-weight: 500;
    }
    .geo-list li span.aux {
      font-size: 0.98rem;
      color: #b5bac1;
      font-weight: 400;
    }
    .zh-space {
      margin-left: 0.25em;
    }
    .map-area {
      flex: 1 1 0;
      height: 100vh;
      position: relative;
      z-index: 1;
      background: #f8f9fa;
    }
    #map {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
      border-radius: 0;
    }
    .loading-indicator {
      display: none;
      text-align: center;
      padding-top: 40px;
      font-size: 1.2rem;
      color: #5f6368;
    }
    @media (max-width: 900px) {
      .main-layout {
        flex-direction: column;
      }
      .sidebar {
        width: 100vw;
        min-width: 0;
        max-width: 100vw;
        height: auto;
        border-radius: 0 0 16px 16px;
        box-shadow: 0 2px 12px 0 rgba(60,64,67,0.08);
      }
      .sidebar-content {
        padding: 20px 5vw 16px 5vw;
      }
      .map-area {
        flex: 1 1 0;
        height: 60vh;
        min-height: 220px;
      }
      #map {
        border-radius: 0 0 12px 12px;
      }
    }
  </style>
</head>
<body>
  <div class="main-layout">
    <!-- 左侧信息栏 -->
    <aside class="sidebar">
      <div class="sidebar-content">
        <div class="sidebar-title">
          IP GeoMap
        </div>
        <div id="ip-sections">
          <!-- IPv4 信息分栏 -->
          <ul class="geo-list" id="geo-list-ipv4" style="display: none; margin-bottom: 32px;">
            <div class="geo-list-group">
              <div class="geo-list-group-title">IPv4 Network</div>
              <li><strong>IP Address:</strong> <span></span></li>
              <li><strong>ASN:</strong> <span></span></li>
              <li><strong>ISP:</strong> <span></span></li>
              <li><strong>Datacenter:</strong> <span></span></li>
            </div>
            <div class="geo-list-group">
              <div class="geo-list-group-title">Location</div>
              <li><strong>Country:</strong> <span></span></li>
              <li><strong>City:</strong> <span></span></li>
              <li><strong>Region/State:</strong> <span></span></li>
              <li><strong>Postal Code:</strong> <span></span></li>
              <li><strong>Longitude:</strong> <span class="mono"></span></li>
              <li><strong>Latitude:</strong> <span class="mono"></span></li>
            </div>
          </ul>
          <hr class="geo-list-divider" style="margin: 28px 0 24px 0;">
          <!-- IPv6 信息分栏 -->
          <ul class="geo-list" id="geo-list-ipv6" style="display: none;">
            <div class="geo-list-group">
              <div class="geo-list-group-title">IPv6 Network</div>
              <li><strong>IP Address:</strong> <span></span></li>
              <li><strong>ASN:</strong> <span></span></li>
              <li><strong>ISP:</strong> <span></span></li>
              <li><strong>Datacenter:</strong> <span></span></li>
            </div>
            <div class="geo-list-group">
              <div class="geo-list-group-title">Location</div>
              <li><strong>Country:</strong> <span></span></li>
              <li><strong>City:</strong> <span></span></li>
              <li><strong>Region/State:</strong> <span></span></li>
              <li><strong>Postal Code:</strong> <span></span></li>
              <li><strong>Longitude:</strong> <span class="mono"></span></li>
              <li><strong>Latitude:</strong> <span class="mono"></span></li>
            </div>
          </ul>
        </div>
      </div>
    </aside>
    <!-- 右侧地图区域 -->
    <div class="map-area">
      <div id="map"></div>
    </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.3/leaflet.js" crossorigin></script>
  <script>
    let map;
    let marker;
    let ipv4Data = null;
    let ipv6Data = null;
    const countryMap = {
      'JP': '日本', 'US': '美国', 'CN': '中国', 'DE': '德国', 'FR': '法国', 'GB': '英国', 'KR': '韩国', 'IN': '印度', 'RU': '俄罗斯', 'SG': '新加坡', 'AU': '澳大利亚', 'CA': '加拿大', 'BR': '巴西', 'NL': '荷兰', 'HK': '中国香港', 'TW': '中国台湾'
    };
    const cityMap = {
      'Inzai': '印西', 'Los Angeles': '洛杉矶', 'Beijing': '北京', 'Shanghai': '上海', 'Chiba': '千叶', 'Singapore': '新加坡', 'London': '伦敦', 'Frankfurt': '法兰克福'
    };
    const regionMap = {
      'Chiba': '千叶', 'California': '加利福尼亚', 'Beijing': '北京', 'Shanghai': '上海', 'Tokyo': '东京', 'New York': '纽约'
    };
    async function translateText(text, targetLang = 'zh-CN') {
      if (!text) return '';
      try {
        const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${targetLang}&dt=t&q=${encodeURIComponent(text)}`;
        const res = await fetch(url);
        const data = await res.json();
        return data[0][0][0];
      } catch (e) {
        return '';
      }
    }
    async function fillGeo(data, type) {
      const geoList = document.getElementById(type === 'ipv4' ? 'geo-list-ipv4' : 'geo-list-ipv6');
      geoList.dataset.filled = '1';
      let countryZh = countryMap[data.country];
      if (!countryZh && data.country) countryZh = await translateText(data.country);
      let cityZh = cityMap[data.city];
      if (!cityZh && data.city) cityZh = await translateText(data.city);
      countryZh = countryZh ? `<span class='zh-space'>| ${countryZh}</span>` : '';
      cityZh = cityZh ? `<span class='zh-space'>| ${cityZh}</span>` : '';
      const fields = [
        data.clientIp ?? data.ip_address ?? 'null',
        data.asn ? 'AS' + data.asn : 'null',
        data.asOrganization ?? data.isp ?? 'null',
        data.colo ?? 'null',
        (data.country ?? 'null') + countryZh,
        (data.city ?? 'null') + cityZh,
        data.region ?? 'null',
        data.postalCode ?? 'null',
        data.longitude ?? 'null',
        data.latitude ?? 'null'
      ];
      const spans = geoList.querySelectorAll('span');
      spans.forEach((el, i) => {
        el.className = '';
        if (i === 4 || i === 5) {
          const englishPart = fields[i].split('<span')[0].trim() || '';
          if (englishPart === 'null') {
            el.textContent = 'null';
          } else {
            el.innerHTML = fields[i] || 'null';
          }
        } else {
          el.textContent = fields[i] || 'null';
        }
      });
      checkShowBothSections();
    }
    function handleFetchError(type) {
      const geoList = document.getElementById(type === 'ipv4' ? 'geo-list-ipv4' : 'geo-list-ipv6');
      geoList.dataset.filled = '1';
      const spans = geoList.querySelectorAll('span');
      spans.forEach(el => { el.textContent = 'null'; });
      checkShowBothSections();
    }
    function checkShowBothSections() {
      const v4 = document.getElementById('geo-list-ipv4');
      const v6 = document.getElementById('geo-list-ipv6');
      if (v4.dataset.filled === '1' && v6.dataset.filled === '1') {
        v4.style.display = 'block';
        v6.style.display = 'block';
      }
    }
    function hideBothSections() {
      document.getElementById('geo-list-ipv4').style.display = 'none';
      document.getElementById('geo-list-ipv6').style.display = 'none';
      document.getElementById('geo-list-ipv4').dataset.filled = '';
      document.getElementById('geo-list-ipv6').dataset.filled = '';
    }
    function initMap(lat, lng) {
      const mapElement = document.getElementById('map');
      if (!mapElement) return;
      if (!map) {
        mapElement.style.display = 'block';
        map = L.map('map').setView([lat, lng], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: 'Map data © <a href="https://openstreetmap.org">OpenStreetMap</a> contributors',
          maxZoom: 18,
        }).addTo(map);
      }
      if (marker) {
        map.removeLayer(marker);
      }
      marker = L.marker([lat, lng]).addTo(map);
    }
    async function fetchIPv4() {
      try {
        const response = await fetch('https://ipv4-check-perf.radar.cloudflare.com/');
        const data = await response.json();
        ipv4Data = data;
        await fillGeo(data, 'ipv4');
        if (data.latitude != null && data.longitude != null) {
          initMap(data.latitude, data.longitude);
        }
      } catch (err) {
        handleFetchError('ipv4');
      }
    }
    async function fetchIPv6() {
      try {
        const response = await fetch('https://ipv6-check-perf.radar.cloudflare.com/');
        const data = await response.json();
        ipv6Data = data;
        await fillGeo(data, 'ipv6');
        if ((!ipv4Data || !ipv4Data.latitude || !ipv4Data.longitude) && data.latitude != null && data.longitude != null) {
          initMap(data.latitude, data.longitude);
        }
      } catch (err) {
        handleFetchError('ipv6');
      }
    }
    window.onload = () => {
      hideBothSections();
      initMap(0, 0);
      fetchIPv4();
      fetchIPv6();
    };
  </script>
</body>
</html> 